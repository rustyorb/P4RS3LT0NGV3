#!/usr/bin/env node

/**
 * Build Script for Transformers Index
 * Dynamically generates index.js with all transformer imports
 */

const fs = require('fs');
const path = require('path');

const transformersDir = path.join(__dirname, '..', 'src', 'transformers');
const outputPath = path.join(transformersDir, 'index.js');

// Files to skip
const skipFiles = ['BaseTransformer.js', 'index.js', 'loader.js', 'loader-node.js', 'README.md'];

// Get all category directories
const categoryDirs = fs.readdirSync(transformersDir, { withFileTypes: true })
    .filter(dirent => dirent.isDirectory())
    .map(dirent => dirent.name)
    .sort();

let imports = [];
let transformNames = [];

// Discover transforms from each category directory
for (const categoryDir of categoryDirs) {
    const categoryPath = path.join(transformersDir, categoryDir);
    const files = fs.readdirSync(categoryPath)
        .filter(file => file.endsWith('.js') && !skipFiles.includes(file))
        .sort();
    
    for (const file of files) {
        // Convert filename to transform name (kebab-case to snake_case)
        const transformName = file.replace('.js', '').replace(/-/g, '_');
        const filePath = `./${categoryDir}/${file}`;
        
        imports.push(`import ${transformName} from '${filePath}';`);
        transformNames.push(transformName);
    }
}

// Generate the index.js content
const output = `// Transformers Index - Auto-generated
// This file is automatically generated by build/build-index.js
// Do not edit manually - run 'npm run build:index' to regenerate

${imports.join('\n')}

// Combine all transforms
const transforms = {
${transformNames.map(name => `    ${name}`).join(',\n')}
};

// Export for both ES6 modules and browser global
export default transforms;

// Also expose as window.transforms for backward compatibility
if (typeof window !== 'undefined') {
    window.transforms = transforms;
    window.encoders = transforms; // alias
}
`;

// Write the file
fs.writeFileSync(outputPath, output, 'utf8');

console.log(`âœ¨ Generated: ${outputPath}`);
console.log(`ğŸ“¦ Total transforms: ${transformNames.length}`);
console.log(`ğŸ“ Categories: ${categoryDirs.join(', ')}`);

